<script src="http://cdn.alloyui.com/3.0.1/aui/aui-min.js"></script>
<h3><?php var_dump($this->_vars); ?></h3>
<input type="hidden" id="uniAclConfig" value='<?php echo json_encode($this->uniAclConfig); ?>'>
<input type="hidden" id="userActionOnRole" value='<?php echo json_encode($this->userActionOnRole); ?>'>
<input type="hidden" id="inheritRole" value='<?php echo json_encode($this->inheritRole); ?>'>
<input type="hidden" id="allRoles" value='<?php echo json_encode($this->allRoles); ?>'>
<input type="hidden" id="allControllerAction" value='<?php echo json_encode($this->allControllerAction); ?>'>
<input type="hidden" id="mapRoleWhere" value='<?php echo json_encode($this->mapRoleWhere); ?>'>
<!-- CONTROLLER !-->
<div id="controller">CONTROLLER</div>
<div id="myTreeView"></div>

<li id="sampleRoleRow" style="display: none;">
    <input type="text" readonly name="inheritRole">
    <input type="text" readonly name="parentRole">
    <button class="btn btn-primary allowedAction" data-container="body" data-toggle="tooltip"
            data-placement="right">action
    </button>
</li>

<div id="mapRoleControllerAction">
    <h2>map role controller action</h2>
    <div id="adminControllerAction"></div>
</div>

<button id="scan" class="btn btn-primary">scan</button>

<div class="container">
    <div class="row">
        <div class="col-sm-3 col-md-3">
            <div class="panel-group" id="accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne"><span
                                    class="glyphicon glyphicon-folder-close">
                            </span>Content</a>
                        </h4>
                    </div>
                    <div id="collapseOne" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <table class="table">
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-pencil text-primary"></span><a
                                            href="http://www.jquery2dotnet.com">Articles</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-flash text-success"></span><a
                                            href="http://www.jquery2dotnet.com">News</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-file text-info"></span><a
                                            href="http://www.jquery2dotnet.com">Newsletters</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-comment text-success"></span><a
                                            href="http://www.jquery2dotnet.com">Comments</a>
                                        <span class="badge">42</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo"><span
                                    class="glyphicon glyphicon-th">
                            </span>Modules</a>
                        </h4>
                    </div>
                    <div id="collapseTwo" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table">
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Orders</a> <span
                                            class="label label-success">$ 320</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Invoices</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Shipments</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Tex</a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree"><span
                                    class="glyphicon glyphicon-user">
                            </span>Account</a>
                        </h4>
                    </div>
                    <div id="collapseThree" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table">
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Change Password</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Notifications</a> <span
                                            class="label label-info">5</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="http://www.jquery2dotnet.com">Import/Export</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-trash text-danger"></span><a
                                            href="http://www.jquery2dotnet.com" class="text-danger">
                                            Delete Account</a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour"><span
                                    class="glyphicon glyphicon-file">
                            </span>Reports</a>
                        </h4>
                    </div>
                    <div id="collapseFour" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table">
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-usd"></span><a
                                            href="http://www.jquery2dotnet.com">Sales</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-user"></span><a
                                            href="http://www.jquery2dotnet.com">Customers</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-tasks"></span><a
                                            href="http://www.jquery2dotnet.com">Products</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-shopping-cart"></span><a
                                            href="http://www.jquery2dotnet.com">Shopping Cart</a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-9 col-md-9">
            <div class="well">
                <h1>
                    Accordion Menu With Icon</h1>
                Admin Dashboard Accordion Menu
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-8">
        <div class="panel-group">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title" data-toggle="collapse" href="#rolePanelBody">role</div>
                </div>
                <div id="rolePanelBody" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p>hien thi thong tin ve inherit-role</p>
                        <div id="inheritRoleShow"></div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title" data-toggle="collapse" href="#mapPanelBody">map role where</div>
                </div>
                <div id="mapPanelBody" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p>common</p>
                        <p>special (no inherit)</p>
                        <div id="mapRoleWhereShow">
                            <div id="selectContainer"></div>
                            <h3>INHERIT</h3>
                            <div id="mapRoleWhereInherit"></div>
                            <h3>NOT INHERIT</h3>
                            <div id="mapRoleWhereNotInherit"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title" data-toggle="collapse" href="#allRolePanelBody">all roles</div>
                </div>
                <div id="allRolePanelBody" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p>hien thi tat cac role</p>
                        <div id="allRolesShow"></div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title" data-toggle="collapse" href="#controllerActionPanelBody">controller
                        action
                    </div>
                </div>
                <div id="controllerActionPanelBody" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p>hien thi tat cac controller action</p>
                        <div id="allControllerActionShow"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    (function($){
        $(document).ready(function(){
            const CONTROLLER_ACTION = "CONTROLLER_ACTION";
            const ROLE = "ROLE";
            const INHERIT = "INHERIT";
            const NOT_INHERIT = "NOT_INHERIT";
            /**
             * READ CONFIG from server
             */
            var uniAclConfig = JSON.parse($("#uniAclConfig").val());
            var userActionOnRole = JSON.parse($("#userActionOnRole").val());

            var allRoles = JSON.parse($("#allRoles").val());

//            var userActionOnRole = ["view", "edit", "add", "delete"];
            console.log(uniAclConfig);
            console.log(userActionOnRole);

            /**
             * VIEW on CONTROLLER
             */
            var controllerAction = uniAclConfig[CONTROLLER_ACTION];
//            var auiTreeData = buildTreeData(controllerAction);
            renderTree(controllerAction, "#myTreeView");


            /**
             * map role scontroller
             */
            const MAP_ROLE_CONTROLLER_ACTION = "MAP_ROLE_CONTROLLER_ACTION";
//            var mapRoleController = uniAclConfig[MAP_ROLE_CONTROLLER_ACTION];
//            var mapDiv = $("#mapRoleControllerAction");
//            var guest = JSON.parse($("#guest").val());
//            var admin = JSON.parse($("#admin").val());
//            var adminTreeData = buildTreeData(admin);
//            renderTree(adminTreeData, "#adminControllerAction");

            /**
             * load ROLE
             */
            var inheritRole = JSON.parse($("#inheritRole").val());
            renderInheritRole(inheritRole, $("#inheritRoleShow"));

            /**
             * map ROLE WHERE
             */
//            var allRoles = JSON.parse($("#allRoles").val());
            var mapRoleWhere = JSON.parse($("#mapRoleWhere").val());
//            console.log(mapRoleWhere);
            var selectContainer = $("#selectContainer");
            renderAllRoles(allRoles, selectContainer);
            //bind event on select
            selectContainer.children("select").on("change", function(){
                var optionSelected = $(this).children("option:selected");
                var role = optionSelected.val();
                console.log(role);
                var s = buildTreeData(mapRoleWhere[role][INHERIT]);
                console.log(s);
                //clean div container treeview
                $("#mapRoleWhereInherit").empty();
                $("#mapRoleWhereNotInherit").empty();
                renderTree(mapRoleWhere[role][INHERIT], "#mapRoleWhereInherit");
                renderTree(mapRoleWhere[role][NOT_INHERIT], "#mapRoleWhereNotInherit");
            });
            /**
             * ALL ROLES
             */
            /** @warn allRoles at first line */
            renderAllRoles(allRoles, $("#allRolesShow"));

            /**
             * ALL CONTROLLER ACTION
             */
            var allControllerAction = JSON.parse($("#allControllerAction").val());
//            console.log(allControllerAction);
            renderTree(allControllerAction, "#allControllerActionShow");
            $("#scan").on("click", function(){
                var ul = $("#adminControllerAction").children("ul");
                var treeData = {};
                getTreeData(ul, treeData);
                console.log(treeData);
            });
        });
    })(jQuery);

    function buildTreeData(controllerAction){
        var treeData = [];
        for(var controller in controllerAction){
            if(controllerAction.hasOwnProperty(controller)){
                var actionData = [];
                //build each controller as node
                treeData.push({
                    children: actionData,
                    expanded: true,
                    label: controller,
                    type: 'task',
                    checked: true
                });

                //build actionData, into controller as child-node
                var actionArray = controllerAction[controller];
                for(var i = 0; i < actionArray.length; i++){
                    actionData.push({
                        label: actionArray[i],
                        leaf: true,
                        type: 'task',
                        checked: true
                    })
                }
            }
        }
        return treeData;
    }

    function getTreeData(ul, store){
        var liArray = ul.children("li");
        /** @warn for each not work as expected of recursive*/
        for(var i = 0; i < liArray.length; i++){
            var li = $(liArray[i]);
            var contentDiv = li.children("div");
            var containerUl = li.children("ul");
            if(contentDiv.hasClass("tree-node-checked")){
                var label = contentDiv.children(".tree-label").html();
//                console.log(label);
                /** @warn handle different on controller|action */
                if(containerUl.children("li").length > 0){
                    store[label] = [];
                    getTreeData(containerUl, store[label]);
                }else{
                    store.push(label);
                }

            }
        }
    }

    function renderTree(controllerAction, containerDivId){
        var treeData = buildTreeData(controllerAction);
        YUI().use('aui-tree-view', function(Y){
                new Y.TreeView({boundingBox: containerDivId, children: treeData}).render();
            }
        );
    }

    function renderInheritRole(inheritRole, containerDiv){
        var sampleRoleRow = $("#sampleRoleRow");
        for(var inherit in inheritRole){
            if(inheritRole.hasOwnProperty(inherit)){
                var row = sampleRoleRow.clone();
                row.css({display: 'block'});
                row.find("input[name='inheritRole']").val(inherit);
                row.find("input[name='parentRole']").val(inheritRole[inherit]);
                containerDiv.append(row);
            }
        }
    }
    //    function init(){
    //        var title = actionDiv();
    //        $('[data-toggle="tooltip"]').tooltip({
    //            html: true
    //            title: title
    //        });
    //    }

    //    function actionDiv(userActionRole){
    //        /**
    //         * action user can
    //         */
    //        var actionDiv = $("<div>");
    //        var sampleIcon = $("<span class='glyphicon'></span>");
    //        for(var key in userActionOnRole){
    //            if(userActionOnRole.hasOwnProperty(key)){
    //                var action = userActionOnRole[key];
    //                var icon = sampleIcon.clone();
    //                switch(action){
    //                    case "edit":
    //                        icon.addClass("glyphicon-pencil");
    //                        break;
    //                    case "add":
    //                        icon.addClass("glyphicon-plus");
    //                        break;
    //                    case "delete":
    //                        icon.addClass("glyphicon-trash");
    //                        break;
    //                    default:
    //                        break;
    //                }
    //                actionDiv.append(icon);
    //            }
    //        }
    //        return actionDiv;
    //    }

    function renderAllRoles(allRoles, containerDiv){
//            <select class="selectpicker">
//                <option>Mustard</option>
//                <option>Ketchup</option>
//                <option>Relish</option>
//            </select>
        var select = $('<select class="selectpicker">');
        var optionSample = $("<option>");
        //when loop for i++, means key just number
        //sometimes key in array like php has info
        //for(var key in array){ do sth}
        for(var i = 0; i < allRoles.length; i++){
            var option = optionSample.clone();
            option.html(allRoles[i]);
            select.append(option);
        }
        containerDiv.append(select);
    }

    function renderRoleWhere(){
        /**
         * CONTROLLER ACTION
         */

        /**
         * SPECIAL, not inherit
         */
    }
</script>

